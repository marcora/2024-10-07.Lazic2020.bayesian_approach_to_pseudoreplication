---
title: "A Bayesian predictive approach for dealing with pseudoreplication"
date: 2024-10-07
author: "Lazic SE, Mellor JR, Ashby MC, et al."
format:
  html:
    df-print: paged
    toc: true
execute: 
  warning: false
---

## Introduction

Lazic, S.E., Mellor, J.R., Ashby, M.C. *et al.* A Bayesian predictive approach for dealing with pseudoreplication. *Sci Rep* **10**, 2366 (2020)

<https://doi.org/10.1038/s41598-020-59384-7>

## Setup environment

```{r}
#| output: false
library(tidyverse)
library(magrittr)
library(broom)
library(ggformula)
library(ggeffects)
library(performance)

library(rethinking)
library(brms)
library(nlme)
library(bayesplot)
library(flexplot)

options(mc.cores = parallel::detectCores())
```

## Read and prep data

<https://doi.org/10.3389/fnmol.2014.00030>

```{r}
dat <- read_csv("Moen_data.csv", show_col_types = FALSE)

dat
```

```{r}
dat %>%
  filter(pten == 0 & fa != 2) %>%
  select(mouseid, fa, somasize) %>%
  mutate(
    mouseid = factor(mouseid),
    fa = factor(fa, levels = c(0, 1), labels = c("Vehicle", "FA")),
) -> d

d
```

```{r}
## average somasize by animal
d %>%
    group_by(mouseid, fa) %>%
    summarise(somasize = mean(somasize)) %>%
    ungroup() ->
    d.avg

d.avg
```

## Exploratory data analysis

```{r}
skimr::skim(d)
```

```{r}
flexplot(somasize ~ fa + mouseid, data = d)
```

## Correct and incorrect frequentist analysis using independent sample *t*-test

```{r}
t.test(somasize ~ fa, data = d) %>% tidy() # incorrect
```

```{r}
t.test(somasize ~ fa, data = d.avg) %>% tidy() # correct
```

## Correct Bayesian analysis using multilevel/hierarchical linear model and posterior predictive approach

### Specify model

$$
\begin{align*}
\text{somasize}_{ij} &\sim \text{Normal}(\mu_{ij}, \sigma) \\
\mu_{ij} &= \alpha + \beta \times \text{group}_{i} + \gamma_{j} \\
\gamma_{j} &\sim \text{Normal}(0, \sigma_{\gamma}) \\
\\
\alpha &\sim \text{Student}_t(3, 93, 15) \\
\beta &\sim \text{Normal}(0, 20) \\
\sigma &\sim \text{Student}_t(3, 0, 15) \\
\sigma_{\gamma} &\sim \text{Student}_t(3, 0, 15)
\end{align*}
$$

```{r}
fit <- ulam(
  alist(
    somasize ~ normal(mu, sigma),
    mu <-  alpha + beta * fa + tau[mouseid],
    tau[mouseid] ~ normal(0, sigma_tau),
    alpha ~ student_t(3, 93, 15),
    beta ~ normal(0, 20),
    sigma ~ student_t(3, 0, 15),
    sigma_tau ~ student_t(3, 0, 15)),
  data = d)
```

```{r}
precis(fit)
```

```{r}
plot(fit)
```

## Print environment

```{r}
sessioninfo::session_info()
```
